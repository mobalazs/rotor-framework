import "pkg:/source/RotorFramework.bs"
import "pkg:/components/tests/dispatcherTest/DispatcherTest.template.bs"
import "pkg:/components/tests/dispatcherTest/DispatcherTest.const.bs"

namespace tests

    @SGNode("dispatcherTest")
    @suite("DispatcherProviderPlugin Test Suite")
    class dispatcherProviderPluginTestSuite extends rooibos.BaseTestSuite

        fwInstance as Rotor.Framework

        protected override function beforeEach()
            ' Initialize framework
            m.fwInstance = new Rotor.Framework()

            ' Register test dispatchers using Rotor.createDispatcher
            Rotor.createDispatcher("testDispatcher", new Rotor.Model({ foo: "bar" }), new Rotor.Reducer())
            Rotor.createDispatcher("dispatcher1", new Rotor.Model({ foo: "bar" }), new Rotor.Reducer())
            Rotor.createDispatcher("dispatcher2", new Rotor.Model({ foo: "bar" }), new Rotor.Reducer())
            Rotor.createDispatcher("dispatcher3", new Rotor.Model({ foo: "bar" }), new Rotor.Reducer())
        end function

        protected override function afterEach()
            m.fwInstance.destroy()
            m.fwInstance = invalid
        end function

        @describe("DispatcherProviderPlugin lifecycle")

        @it("attaches dispatcher on beforeMount")
        function _()
            ' Create template with dispatcher
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: "testDispatcher"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            m.assertNotInvalid(widget)
            m.assertNotInvalid(widget.viewModelState.dispatcher)
            m.assertNotInvalid(widget.viewModelState.dispatcher.testDispatcher)
        end function

        @it("attaches multiple dispatchers")
        function _()
            ' Create template with multiple dispatchers
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: ["dispatcher1", "dispatcher2"]
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            m.assertNotInvalid(widget)
            m.assertNotInvalid(widget.viewModelState.dispatcher)
            m.assertNotInvalid(widget.viewModelState.dispatcher.dispatcher1)
            m.assertNotInvalid(widget.viewModelState.dispatcher.dispatcher2)
        end function

        @it("handles single dispatcher string config")
        function _()
            ' Create template with single dispatcher string
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: "dispatcher1"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            ' Single dispatcher should be attached
            m.assertNotInvalid(widget.viewModelState.dispatcher)
            m.assertNotInvalid(widget.viewModelState.dispatcher.dispatcher1)
        end function

        @it("handles widget without dispatcher config")
        function _()
            ' Create template without dispatcher
            template = {
                id: "testWidget",
                type: "Group"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            m.assertNotInvalid(widget)
            ' viewModelState.dispatcher should be invalid or empty
        end function

        @it("dispatcher facade provides dispatch functionality")
        function _()
            ' Create template with dispatcher
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: "testDispatcher"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            dispatcherFacade = widget.viewModelState.dispatcher.testDispatcher
            m.assertNotInvalid(dispatcherFacade)

            ' Dispatcher facade should have methods
            m.assertNotInvalid(dispatcherFacade.dispatch)
            m.assertNotInvalid(dispatcherFacade.getState)
        end function

        @it("does not create duplicate dispatcher facades")
        function _()
            ' Create template with same dispatcher twice
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: ["dispatcher1", "dispatcher1"]
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            m.assertNotInvalid(widget.viewModelState.dispatcher.dispatcher1)

            ' Should have only one facade instance (no duplicates)
            ' This test verifies the code doesn't crash with duplicate IDs
            m.assertTrue(true)
        end function

        @it("handles invalid viewModelState gracefully")
        function _()
            ' Create a basic template
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: "testDispatcher"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            ' Should handle access to dispatcher
            m.assertNotInvalid(widget.viewModelState)
            m.assertNotInvalid(widget.viewModelState.dispatcher)
        end function

        @it("dispatcher array config is converted to array internally")
        function _()
            ' Create template with array of one dispatcher
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: ["dispatcher1"]
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            ' Dispatcher should be accessible even when passed as single-element array
            m.assertNotInvalid(widget.viewModelState.dispatcher)
            m.assertNotInvalid(widget.viewModelState.dispatcher.dispatcher1)
        end function

        @it("dispatcher can dispatch actions")
        function _()
            ' Create template with dispatcher
            template = {
                id: "testWidget",
                type: "Group",
                dispatcher: "testDispatcher"
            }

            m.fwInstance.render(template)
            widget = m.fwInstance.getWidget("testWidget")

            dispatcherFacade = widget.viewModelState.dispatcher.testDispatcher
            m.assertNotInvalid(dispatcherFacade)

            ' Get initial state
            state = dispatcherFacade.getState()
            m.assertNotInvalid(state)

            ' Test passes - dispatcher facade is functional
            m.assertTrue(true)
        end function

    end class
end namespace
