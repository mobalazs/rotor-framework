import "pkg:/source/RotorFramework.bs"
import "pkg:/source/engine/Constants.bs"
import "pkg:/components/tests/focusPluginTest/FocusPluginTest.template.bs"

namespace tests

    @SGNode("focusPluginTest")
    @suite("FocusPluginTestSuite integration")
    class FocusPluginTestSuite extends rooibos.BaseTestSuite

        fwInstance as Rotor.Framework

        protected override function beforeEach()
            ' Initialize framework
            m.fwInstance = new Rotor.Framework()
            ' Render
            template = getFocusTestTemplate()
            m.fwInstance.render(template)
            ' Disable longPress feature
            m.fwInstance.plugins.focusenableLongPressFeature = false
            ' Set initial focus to L1 (by using the topWidget group and its capturing feature)
            topWidget = m.fwInstance.getWidget("topWidget")
            topWidget.setFocus()
        end function

        protected override function afterEach()
            m.fwInstance.destroy()
            m.fwInstance = invalid
        end function

        ' ======================================================================
        ' TEST SUITE 1: Initialization and Toggles
        ' ======================================================================

        @describe("initialization and toggles")

        @it("enables focus navigation and validates state")
        function _()
            ' VAlidate initial focus (focus has been set by capturing feature)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "L1")
            ' Given: Framework is initialized with L1 focused
            l1Widget = m.fwInstance.getWidget("L1")
            m.assertNotInvalid(l1Widget)

            ' Then: Focus navigation should be enabled
            m.assertTrue(l1Widget.isFocusNavigationEnabled())
        end function

        @it("validates initial focus is on L1")
        function _()
            ' Given: Framework is initialized with initial focus on L1
            l1Widget = m.fwInstance.getWidget("L1")

            ' Then: Focus should be on L1
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
            m.assertTrue(focusedWidget.isFocused())
        end function

        ' ======================================================================
        ' TEST SUITE 2: Directional Navigation (Global)
        ' ======================================================================

        @describe("directional navigation from L1")

        @it("stays on L1 when pressing left (edge of group)")
        function _()
            ' Given: Focus is on L1 (leftmost in GroupL2)
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press left key (should stay or be captured)
            l1Widget.triggerKeyPress("left")

            ' Then: Focus should remain on L1 (no left neighbor)
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
        end function

        @it("navigates from L1 up (if up direction configured)")
        function _()
            ' Given: Focus is on L1
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press up key
            l1Widget.triggerKeyPress("up")

            ' Then: Focus should move per configuration (test what actually happens)
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Adjust expectation based on template configuration
        end function

        @it("navigates from L1 down (if down direction configured)")
        function _()
            ' Given: Focus is on L1
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press down key
            l1Widget.triggerKeyPress("down")

            ' Then: Focus should move per configuration (test what actually happens)
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Adjust expectation based on template configuration
        end function

        ' ======================================================================
        ' TEST SUITE 4: Focus Capturing (Inner Groups)
        ' ======================================================================

        @describe("focus capturing in GroupL2 with horizontal capture enabled")

        @it("captures left key from L1 - stays within GroupL2")
        function _()
            ' Given: Focus is on L1 (set in beforeEach)
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press left key (should be captured if configured)
            l1Widget.triggerKeyPress("left")

            ' Then: Focus should remain on L1 (captured, no exit from group)
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
        end function

        @it("bubbles right key from L2 to GroupR2 via topWidget")
        function _()
            ' Given: Focus is moved to L2 (rightmost in GroupL2)
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("L2")

            ' When: Press right key (bubbles up, topWidget.right -> GroupR2)
            l2Widget = m.fwInstance.getWidget("L2")
            l2Widget.triggerKeyPress("right")

            ' Then: Focus should move to R1 (defaultFocusId of GroupR2)
            focusedWidget = l2Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "R1")
        end function

        @describe("focus capturing in GroupR2 with horizontal capture enabled")

        @it("captures left key from R1 - stays within GroupR2")
        function _()
            ' Given: Focus is moved to R1
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("R1")

            ' When: Press left key (should be captured if configured)
            r1Widget = m.fwInstance.getWidget("R1")
            r1Widget.triggerKeyPress("left")

            ' Then: Focus should remain on R1
            focusedWidget = r1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "R1")
        end function

        @it("captures right key from R2 - stays within GroupR2")
        function _()
            ' Given: Focus is moved to R2
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("R2")

            ' When: Press right key (should be captured if configured)
            r2Widget = m.fwInstance.getWidget("R2")
            r2Widget.triggerKeyPress("right")

            ' Then: Focus should remain on R2
            focusedWidget = r2Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "R2")
        end function

        ' ======================================================================
        ' TEST SUITE 5: Focus Bubbling (Depth 3 to Top)
        ' ======================================================================

        @describe("focus bubbling from inner groups")

        @it("bubbles from L1 up (per group configuration)")
        function _()
            ' Given: Focus is on L1 (set in beforeEach)
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press up key
            l1Widget.triggerKeyPress("up")

            ' Then: Focus should bubble per GroupL2.up configuration
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Verify based on actual template configuration
        end function

        @it("bubbles from L2 up (per group configuration)")
        function _()
            ' Given: Focus is moved to L2
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("L2")

            ' When: Press up key
            l2Widget = m.fwInstance.getWidget("L2")
            l2Widget.triggerKeyPress("up")

            ' Then: Focus should bubble per GroupL2.up configuration
            focusedWidget = l2Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Verify based on actual template configuration
        end function

        @it("bubbles from R1 up (per group configuration)")
        function _()
            ' Given: Focus is moved to R1
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("R1")

            ' When: Press up key
            r1Widget = m.fwInstance.getWidget("R1")
            r1Widget.triggerKeyPress("up")

            ' Then: Focus should bubble per GroupR2.up configuration
            focusedWidget = r1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Verify based on actual template configuration
        end function

        @it("bubbles from R2 up (per group configuration)")
        function _()
            ' Given: Focus is moved to R2
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("R2")

            ' When: Press up key
            r2Widget = m.fwInstance.getWidget("R2")
            r2Widget.triggerKeyPress("up")

            ' Then: Focus should bubble per GroupR2.up configuration
            focusedWidget = r2Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            ' Note: Verify based on actual template configuration
        end function

        ' ======================================================================
        ' TEST SUITE 6: Node Tree Structure Validation
        ' ======================================================================

        @describe("focus test template produces expected node tree")

        @it("creates expected nodes in native tree")
        function _()
            ' Given: Framework is initialized
            rootWidget = m.fwInstance.getRootWidget()
            m.assertNotInvalid(rootWidget)

            ' Then: Validate topWidget group structure
            topWidget = rootWidget.children.topWidget
            m.assertNotInvalid(topWidget)
            m.assertEqual(topWidget.id, "topWidget")

            ' Validate left branch structure (GroupL -> GroupL2 -> L1, L2)
            groupL = m.fwInstance.getWidget("GroupL")
            m.assertNotInvalid(groupL)
            m.assertEqual(groupL.id, "GroupL")

            groupL2 = m.fwInstance.getWidget("GroupL2")
            m.assertNotInvalid(groupL2)
            m.assertEqual(groupL2.id, "GroupL2")

            l1 = m.fwInstance.getWidget("L1")
            m.assertNotInvalid(l1)
            m.assertEqual(l1.id, "L1")
            m.assertEqual(l1.node.subtype(), "Rectangle")

            l2 = m.fwInstance.getWidget("L2")
            m.assertNotInvalid(l2)
            m.assertEqual(l2.id, "L2")
            m.assertEqual(l2.node.subtype(), "Rectangle")

            ' Validate right branch structure (GroupR -> GroupR2 -> R1, R2)
            groupR = m.fwInstance.getWidget("GroupR")
            m.assertNotInvalid(groupR)
            m.assertEqual(groupR.id, "GroupR")

            groupR2 = m.fwInstance.getWidget("GroupR2")
            m.assertNotInvalid(groupR2)
            m.assertEqual(groupR2.id, "GroupR2")

            r1 = m.fwInstance.getWidget("R1")
            m.assertNotInvalid(r1)
            m.assertEqual(r1.id, "R1")
            m.assertEqual(r1.node.subtype(), "Rectangle")

            r2 = m.fwInstance.getWidget("R2")
            m.assertNotInvalid(r2)
            m.assertEqual(r2.id, "R2")
            m.assertEqual(r2.node.subtype(), "Rectangle")
        end function

        ' ======================================================================
        ' TEST SUITE 7: Deep Search for defaultFocusId
        ' ======================================================================

        @describe("deep search for defaultFocusId - focusItem 3 levels down")

        @it("finds DeepTarget 3 levels down when setting focus on DeepSearchGroup")
        function _()
            ' Given: DeepSearchGroup has defaultFocusId: "DeepTarget" which is 3 levels deep
            deepSearchGroup = m.fwInstance.getWidget("DeepSearchGroup")
            m.assertNotInvalid(deepSearchGroup)

            ' When: Set focus on DeepSearchGroup (should trigger capturing with deep search)
            deepSearchGroup.setFocus("DeepSearchGroup")

            ' Then: Focus should be on DeepTarget (3 levels down)
            focusedWidget = deepSearchGroup.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "DeepTarget")
            m.assertTrue(focusedWidget.isFocused())
        end function

        @it("validates DeepTarget exists in the widget tree")
        function _()
            ' Given: Framework is initialized
            deepTarget = m.fwInstance.getWidget("DeepTarget")
            m.assertNotInvalid(deepTarget)
            m.assertEqual(deepTarget.id, "DeepTarget")
            m.assertEqual(deepTarget.node.subtype(), "Rectangle")
        end function

        @describe("deep search for defaultFocusId - nested group with fallback")

        @it("finds nested group and applies its fallback (FinalTarget)")
        function _()
            ' Given: NestedGroupTestParent has defaultFocusId: "NestedTargetGroup" (a group 2 levels down)
            '        NestedTargetGroup has defaultFocusId: "FinalTarget"
            nestedGroupTestParent = m.fwInstance.getWidget("NestedGroupTestParent")
            m.assertNotInvalid(nestedGroupTestParent)

            ' When: Set focus on NestedGroupTestParent
            nestedGroupTestParent.setFocus("NestedGroupTestParent")

            ' Then: Focus should be on FinalTarget (via NestedTargetGroup fallback)
            focusedWidget = nestedGroupTestParent.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "FinalTarget")
            m.assertTrue(focusedWidget.isFocused())
        end function

        @it("validates NestedTargetGroup exists in the widget tree")
        function _()
            ' Given: Framework is initialized
            nestedTargetGroup = m.fwInstance.getWidget("NestedTargetGroup")
            m.assertNotInvalid(nestedTargetGroup)
            m.assertEqual(nestedTargetGroup.id, "NestedTargetGroup")
        end function

        @describe("deep search edge cases")

        @it("deep search does not break existing direct child behavior")
        function _()
            ' Given: GroupL2 has defaultFocusId: "L1" (direct child)
            groupL2 = m.fwInstance.getWidget("GroupL2")
            m.assertNotInvalid(groupL2)

            ' When: Set focus on GroupL2
            groupL2.setFocus("GroupL2")

            ' Then: Focus should be on L1 (existing behavior preserved)
            focusedWidget = groupL2.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
        end function

        ' ======================================================================
        ' TEST SUITE 8: Spatial Navigation Edge Cases
        ' ======================================================================

        @describe("spatial navigation edge cases")

        @it("navigates horizontally within a single focus group via spatial navigation")
        function _()
            ' Given: A simple horizontal layout with 3 items in one focus group
            '   [item1] [item2] [item3]
            '   x=0     x=150   x=300
            template = {
                id: "spatialNavTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "spatialItem1"
                },
                children: [
                    {
                        id: "spatialItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [0, 0] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    },
                    {
                        id: "spatialItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [150, 0] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    },
                    {
                        id: "spatialItem3",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [300, 0] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Set initial focus on item1
            item1 = m.fwInstance.getWidget("spatialItem1")
            item1.setFocus()

            ' Verify initial focus
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "spatialItem1")

            ' When: Press right (should spatially navigate to item2)
            item1.triggerKeyPress("right")

            ' Then: Focus should be on item2
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "spatialItem2")

            ' When: Press right again (should spatially navigate to item3)
            item2 = m.fwInstance.getWidget("spatialItem2")
            item2.triggerKeyPress("right")

            ' Then: Focus should be on item3
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "spatialItem3")

            ' When: Press left (should spatially navigate back to item2)
            item3 = m.fwInstance.getWidget("spatialItem3")
            item3.triggerKeyPress("left")

            ' Then: Focus should be on item2
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "spatialItem2")
        end function

        @it("navigates vertically within a single focus group via spatial navigation")
        function _()
            ' Given: A simple vertical layout with 3 items in one focus group
            '   [item1] y=0
            '   [item2] y=100
            '   [item3] y=200
            template = {
                id: "verticalSpatialNavTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "vItem1"
                },
                children: [
                    {
                        id: "vItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [0, 0] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    },
                    {
                        id: "vItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [0, 100] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    },
                    {
                        id: "vItem3",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 80, translation: [0, 200] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Set initial focus on item1
            item1 = m.fwInstance.getWidget("vItem1")
            item1.setFocus()

            ' Verify initial focus
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "vItem1")

            ' When: Press down (should spatially navigate to item2)
            item1.triggerKeyPress("down")

            ' Then: Focus should be on item2
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "vItem2")

            ' When: Press down again (should spatially navigate to item3)
            item2 = m.fwInstance.getWidget("vItem2")
            item2.triggerKeyPress("down")

            ' Then: Focus should be on item3
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "vItem3")

            ' When: Press up (should spatially navigate back to item2)
            item3 = m.fwInstance.getWidget("vItem3")
            item3.triggerKeyPress("up")

            ' Then: Focus should be on item2
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "vItem2")
        end function

        @it("handles navigation with empty neighbor list")
        function _()
            ' Given: Focus is on L1
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press up (no spatial neighbor above)
            l1Widget.triggerKeyPress("up")

            ' Then: Should either stay or bubble up per configuration
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
        end function

        @it("bubbles from edge of group to adjacent group")
        function _()
            ' Given: Focus on L2 (rightmost in GroupL2)
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.setFocus("L2")

            ' When: Press right (no item to the right in GroupL2, bubbles up)
            l2Widget = m.fwInstance.getWidget("L2")
            l2Widget.triggerKeyPress("right")

            ' Then: Should navigate to R1 via topWidget.right -> GroupR2
            focusedWidget = l2Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "R1")
        end function

        ' ======================================================================
        ' TEST SUITE 9: Bubbling Focus Advanced
        ' ======================================================================

        @describe("bubbling focus advanced scenarios")

        @it("bubbles through multiple group levels")
        function _()
            ' Given: Focus is on L1 (3 levels deep)
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Press down (should bubble up to topWidget group)
            l1Widget.triggerKeyPress("down")

            ' Then: Should bubble and handle per topWidget configuration
            focusedWidget = l1Widget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
        end function

        ' ======================================================================
        ' TEST SUITE 10: Capturing Focus Advanced
        ' ======================================================================

        @describe("capturing focus advanced scenarios")

        @it("capturing resolves group to focusItem correctly")
        function _()
            ' Given: topWidget has defaultFocusId pointing to GroupL2
            topWidget = m.fwInstance.getWidget("topWidget")

            ' When: Set focus on topWidget (should capture to L1 via GroupL2)
            topWidget.setFocus()

            ' Then: Focus should be on L1
            focusedWidget = topWidget.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
        end function

        @describe("focus plugin utility methods")

        @it("getFocusedWidget returns currently focused widget")
        function _()
            ' Given: L1 is focused (set in beforeEach)
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Get focused widget
            focusedWidget = focusPlugin.getFocusedWidget()

            ' Then: Should return L1 widget
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "L1")
        end function

        @it("findAncestorGroups returns empty array for top-level widget")
        function _()
            ' Given: topWidget has no ancestor groups
            topWidget = m.fwInstance.getWidget("topWidget")
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Find ancestor groups for topWidget HID
            ancestorGroups = focusPlugin.findAncestorGroups(topWidget.HID)

            ' Then: Should return empty array (no ancestors)
            m.assertNotInvalid(ancestorGroups)
            m.assertEqual(ancestorGroups.Count(), 0)
        end function

        @it("findAncestorGroups returns parent group for child widget")
        function _()
            ' Given: L1 is inside GroupL2
            l1Widget = m.fwInstance.getWidget("L1")
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Find ancestor groups for L1
            ancestorGroups = focusPlugin.findAncestorGroups(l1Widget.HID)

            ' Then: Should include GroupL2
            m.assertNotInvalid(ancestorGroups)
            m.assertTrue(ancestorGroups.Count() > 0)
        end function

        @describe("focus navigation toggle")

        @it("enableFocusNavigation enables navigation via widget decorator")
        function _()
            ' Given: L1 widget
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Enable navigation via widget decorator
            l1Widget.enableFocusNavigation(true)

            ' Then: Navigation should be enabled
            m.assertTrue(l1Widget.isFocusNavigationEnabled())
        end function

        @it("enableFocusNavigation disables navigation via widget decorator")
        function _()
            ' Given: L1 widget with navigation enabled
            l1Widget = m.fwInstance.getWidget("L1")
            l1Widget.enableFocusNavigation(true)

            ' When: Disable navigation
            l1Widget.enableFocusNavigation(false)

            ' Then: Navigation should be disabled
            m.assertFalse(l1Widget.isFocusNavigationEnabled())
        end function

        @it("isFocusNavigationEnabled returns current state via widget decorator")
        function _()
            ' Given: L1 widget
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Check initial state
            isEnabled = l1Widget.isFocusNavigationEnabled()

            ' Then: Should return boolean
            m.assertNotInvalid(isEnabled)
        end function

        @describe("setFocus edge cases")

        @it("setFocus returns false for invalid ref")
        function _()
            ' Given: Focus plugin
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Try to set focus with invalid ref
            result = focusPlugin.setFocus(invalid)

            ' Then: Should return false
            m.assertFalse(result)
        end function

        @it("setFocus returns false for empty string ref")
        function _()
            ' Given: Focus plugin
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Try to set focus with empty string
            result = focusPlugin.setFocus("")

            ' Then: Should return false
            m.assertFalse(result)
        end function

        @it("setFocus returns false for non-existent widget id")
        function _()
            ' Given: Focus plugin
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Try to set focus with non-existent id
            result = focusPlugin.setFocus("nonExistentWidget123")

            ' Then: Should return false
            m.assertFalse(result)
        end function

        @it("setFocus returns false when already focused")
        function _()
            ' Given: L1 is already focused (set in beforeEach)
            l1Widget = m.fwInstance.getWidget("L1")
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Try to set focus to L1 again
            result = l1Widget.setFocus()

            ' Then: Should return false (no change)
            m.assertFalse(result)
        end function

        ' ======================================================================
        ' TEST SUITE 11: Focus Callbacks (onFocus, onBlur, onSelect)
        ' ======================================================================

        @describe("focus callbacks")

        @it("onFocus callback is called when widget gains focus")
        function _()
            ' Given: A widget with onFocus callback
            onFocusCalled = { value: false }
            template = {
                id: "callbackTestRoot",
                nodeType: "Group",
                focusGroup: { defaultFocusId: "focusCallbackItem" },
                children: [
                    {
                        id: "focusCallbackItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {
                            onFocus: sub()
                                m.testMarker = "onFocus_called"
                            end sub
                        }
                    }
                ]
            }

            ' Destroy existing and create new framework with callback template
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' When: Set focus on the item
            widget = m.fwInstance.getWidget("focusCallbackItem")
            widget.setFocus()

            ' Then: onFocus should have been called
            m.assertEqual(widget.testMarker, "onFocus_called")
        end function

        @it("onBlur callback is called when widget loses focus")
        function _()
            ' Given: Two widgets, one with onBlur callback
            template = {
                id: "blurTestRoot",
                nodeType: "Group",
                focusGroup: { defaultFocusId: "blurItem1" },
                children: [
                    {
                        id: "blurItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {
                            onBlur: sub()
                                m.testMarker = "onBlur_called"
                            end sub
                        }
                    },
                    {
                        id: "blurItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {}
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Set initial focus
            widget1 = m.fwInstance.getWidget("blurItem1")
            widget1.setFocus()

            ' Verify initial state
            m.assertInvalid(widget1.testMarker)

            ' When: Move focus to second item
            widget1.setFocus("blurItem2")

            ' Then: onBlur should have been called on first widget
            m.assertEqual(widget1.testMarker, "onBlur_called")
        end function

        @it("onSelect callback is called when OK is pressed")
        function _()
            ' Given: A widget with onSelect callback
            template = {
                id: "selectTestRoot",
                nodeType: "Group",
                focusGroup: { defaultFocusId: "selectItem" },
                children: [
                    {
                        id: "selectItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {
                            onSelect: sub()
                                m.testMarker = "onSelect_called"
                            end sub
                        }
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Set focus
            widget = m.fwInstance.getWidget("selectItem")
            widget.setFocus()

            ' Verify initial state
            m.assertInvalid(widget.testMarker)

            ' When: Press OK key
            widget.triggerKeyPress("OK")

            ' Then: onSelect should have been called
            m.assertEqual(widget.testMarker, "onSelect_called")
        end function

        @it("onFocusChanged callback is called with isFocused parameter")
        function _()
            ' Given: A widget with onFocusChanged callback
            template = {
                id: "focusChangedTestRoot",
                nodeType: "Group",
                focusGroup: { defaultFocusId: "focusChangedItem1" },
                children: [
                    {
                        id: "focusChangedItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {
                            onFocusChanged: sub(isFocused as boolean)
                                m.lastFocusState = isFocused
                            end sub
                        }
                    },
                    {
                        id: "focusChangedItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {}
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' When: Set focus on first item
            widget1 = m.fwInstance.getWidget("focusChangedItem1")
            widget1.setFocus()

            ' Then: onFocusChanged should be called with true
            m.assertTrue(widget1.lastFocusState)

            ' When: Move focus to second item
            widget1.setFocus("focusChangedItem2")

            ' Then: onFocusChanged should be called with false
            m.assertFalse(widget1.lastFocusState)
        end function

        @it("both onFocus and onBlur are called during focus transition")
        function _()
            ' Given: Two widgets with onFocus and onBlur callbacks
            template = {
                id: "transitionTestRoot",
                nodeType: "Group",
                focusGroup: { defaultFocusId: "transitionItem1" },
                children: [
                    {
                        id: "transitionItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {
                            onFocus: sub()
                                m.focusCount = (m.focusCount ?? 0) + 1
                            end sub,
                            onBlur: sub()
                                m.blurCount = (m.blurCount ?? 0) + 1
                            end sub
                        }
                    },
                    {
                        id: "transitionItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {
                            onFocus: sub()
                                m.focusCount = (m.focusCount ?? 0) + 1
                            end sub,
                            onBlur: sub()
                                m.blurCount = (m.blurCount ?? 0) + 1
                            end sub
                        }
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            widget1 = m.fwInstance.getWidget("transitionItem1")
            widget2 = m.fwInstance.getWidget("transitionItem2")

            ' When: Set focus on first item
            widget1.setFocus()

            ' Then: widget1 onFocus called
            m.assertEqual(widget1.focusCount, 1)
            m.assertInvalid(widget1.blurCount)

            ' When: Move focus to second item
            widget1.setFocus("transitionItem2")

            ' Then: widget1 onBlur called, widget2 onFocus called
            m.assertEqual(widget1.blurCount, 1)
            m.assertEqual(widget2.focusCount, 1)
        end function

        ' ======================================================================
        ' TEST SUITE 12: setGroupLastFocusedId
        ' ======================================================================

        @describe("setGroupLastFocusedId method")

        @it("updates lastFocusedHID when called on a focus group")
        function _()
            ' Given: GroupL2 is a focus group with L1 and L2 items
            groupL2 = m.fwInstance.getWidget("GroupL2")
            focusPlugin = m.fwInstance.plugins.focus

            ' Get the group from the stack
            group = focusPlugin.groupStack.get(groupL2.HID)
            m.assertNotInvalid(group)

            ' When: Call setGroupLastFocusedId with L2's id on the group widget
            groupL2.setGroupLastFocusedId("L2")

            ' Then: The group's lastFocusedHID should be updated to L2's HID
            l2Widget = m.fwInstance.getWidget("L2")
            m.assertEqual(group.lastFocusedHID, l2Widget.HID)
        end function

        @it("updates parent group's lastFocusedHID when called on a focus item")
        function _()
            ' Given: L1 is a focus item inside GroupL2
            l1Widget = m.fwInstance.getWidget("L1")
            focusPlugin = m.fwInstance.plugins.focus

            ' Get the parent group (GroupL2) from the stack
            groupL2Widget = m.fwInstance.getWidget("GroupL2")
            group = focusPlugin.groupStack.get(groupL2Widget.HID)
            m.assertNotInvalid(group)

            ' When: Call setGroupLastFocusedId with L2's id on L1 (a sibling focus item)
            l1Widget.setGroupLastFocusedId("L2")

            ' Then: The parent group's lastFocusedHID should be updated to L2's HID
            l2Widget = m.fwInstance.getWidget("L2")
            m.assertEqual(group.lastFocusedHID, l2Widget.HID)
        end function

        @it("does nothing when called with non-existent id")
        function _()
            ' Given: GroupL2 with initial lastFocusedHID
            groupL2 = m.fwInstance.getWidget("GroupL2")
            focusPlugin = m.fwInstance.plugins.focus

            group = focusPlugin.groupStack.get(groupL2.HID)
            initialLastFocusedHID = group.lastFocusedHID

            ' When: Call setGroupLastFocusedId with non-existent id
            groupL2.setGroupLastFocusedId("nonExistentWidget")

            ' Then: lastFocusedHID should remain unchanged
            m.assertEqual(group.lastFocusedHID, initialLastFocusedHID)
        end function

        @it("resolves id from focusItemStack")
        function _()
            ' Given: L1 is a focus item
            groupL2 = m.fwInstance.getWidget("GroupL2")
            focusPlugin = m.fwInstance.plugins.focus

            group = focusPlugin.groupStack.get(groupL2.HID)
            m.assertNotInvalid(group)

            ' When: Call setGroupLastFocusedId with L1's id (a focus item)
            groupL2.setGroupLastFocusedId("L1")

            ' Then: The group's lastFocusedHID should be updated to L1's HID
            l1Widget = m.fwInstance.getWidget("L1")
            m.assertEqual(group.lastFocusedHID, l1Widget.HID)
        end function

        @it("resolves id from groupStack when not found in focusItemStack")
        function _()
            ' Given: GroupL2 is a group (not a focus item)
            topWidget = m.fwInstance.getWidget("topWidget")
            focusPlugin = m.fwInstance.plugins.focus

            topGroup = focusPlugin.groupStack.get(topWidget.HID)
            m.assertNotInvalid(topGroup)

            ' When: Call setGroupLastFocusedId with GroupL2's id (a group)
            topWidget.setGroupLastFocusedId("GroupL2")

            ' Then: The top group's lastFocusedHID should be updated to GroupL2's HID
            groupL2Widget = m.fwInstance.getWidget("GroupL2")
            m.assertEqual(topGroup.lastFocusedHID, groupL2Widget.HID)
        end function

        ' ======================================================================
        ' TEST SUITE 13: enableDeepLastFocusId (Deep Focus Memory)
        ' ======================================================================

        @describe("enableDeepLastFocusId - deep focus memory")

        @it("ancestor group with enableDeepLastFocusId stores deeply nested focus item HID")
        function _()
            ' Given: A template with enableDeepLastFocusId: true on the outer group
            template = {
                id: "rememberTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "outerGroup"
                },
                children: [
                    {
                        id: "outerGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "innerGroup",
                            enableDeepLastFocusId: true
                        },
                        children: [
                            {
                                id: "innerGroup",
                                nodeType: "Group",
                                fields: { translation: [0, 0] },
                                focusGroup: {
                                    defaultFocusId: "deepItem1"
                                },
                                children: [
                                    {
                                        id: "deepItem1",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [0, 0] },
                                        focus: {}
                                    },
                                    {
                                        id: "deepItem2",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [150, 0] },
                                        focus: {}
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: "otherItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 200] },
                        focus: {}
                    }
                ]
            }

            ' Destroy existing and create new framework
            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' Step 1: Focus deepItem2 (nested 2 levels deep)
            deepItem2 = m.fwInstance.getWidget("deepItem2")
            deepItem2.setFocus()

            ' Step 2: Move focus away to trigger blur (lastFocusedHID is set on blur)
            otherItem = m.fwInstance.getWidget("otherItem")
            otherItem.setFocus()

            ' Get the outer group
            outerGroupWidget = m.fwInstance.getWidget("outerGroup")
            outerGroup = focusPlugin.groupStack.get(outerGroupWidget.HID)

            ' Then: outer group should remember deepItem2's HID (because enableDeepLastFocusId: true)
            m.assertEqual(outerGroup.lastFocusedHID, deepItem2.HID)
        end function

        @it("returns to deeply remembered focus item when re-entering group")
        function _()
            ' Given: Template with enableDeepLastFocusId on outer group
            template = {
                id: "returnTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "outerGroup"
                },
                children: [
                    {
                        id: "outerGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "innerGroup",
                            enableDeepLastFocusId: true,
                            down: "exitGroup"
                        },
                        children: [
                            {
                                id: "innerGroup",
                                nodeType: "Group",
                                fields: { translation: [0, 0] },
                                focusGroup: {
                                    defaultFocusId: "nestedItem1"
                                },
                                children: [
                                    {
                                        id: "nestedItem1",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [0, 0] },
                                        focus: {}
                                    },
                                    {
                                        id: "nestedItem2",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [150, 0] },
                                        focus: {}
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: "exitGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 200] },
                        focusGroup: {
                            defaultFocusId: "exitItem",
                            up: "outerGroup"
                        },
                        children: [
                            {
                                id: "exitItem",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [0, 0] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Step 1: Focus nestedItem2 (deep in hierarchy)
            nestedItem2 = m.fwInstance.getWidget("nestedItem2")
            nestedItem2.setFocus()

            ' Step 2: Navigate away (exit to exitGroup -> exitItem)
            nestedItem2.triggerKeyPress("down")

            ' Verify we're now on exitItem
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "exitItem")

            ' Step 3: Navigate back up to outerGroup
            exitItem = m.fwInstance.getWidget("exitItem")
            exitItem.triggerKeyPress("up")

            ' Then: Focus should return to nestedItem2 (deeply remembered)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "nestedItem2")
        end function

        @it("immediate parent always stores lastFocusedHID regardless of enableDeepLastFocusId")
        function _()
            ' Given: Template where immediate parent does NOT have enableDeepLastFocusId
            template = {
                id: "immediateParentTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "parentGroup"
                },
                children: [
                    {
                        id: "parentGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "childItem1"
                            ' Note: NO enableDeepLastFocusId here
                        },
                        children: [
                            {
                                id: "childItem1",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "childItem2",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [150, 0] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "outsideItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 200] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' Step 1: Focus childItem2
            childItem2 = m.fwInstance.getWidget("childItem2")
            childItem2.setFocus()

            ' Step 2: Move focus away to trigger blur (lastFocusedHID is set on blur)
            outsideItem = m.fwInstance.getWidget("outsideItem")
            outsideItem.setFocus()

            ' Then: Immediate parent should still store lastFocusedHID (default behavior)
            parentGroupWidget = m.fwInstance.getWidget("parentGroup")
            parentGroup = focusPlugin.groupStack.get(parentGroupWidget.HID)
            m.assertEqual(parentGroup.lastFocusedHID, childItem2.HID)
        end function

        @it("ancestor without enableDeepLastFocusId does NOT store deeply nested HID")
        function _()
            ' Given: Outer group without enableDeepLastFocusId, inner group with items
            template = {
                id: "noRememberTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "outerGroup"
                    ' Note: NO enableDeepLastFocusId
                },
                children: [
                    {
                        id: "outerGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "innerGroup"
                            ' Note: NO enableDeepLastFocusId
                        },
                        children: [
                            {
                                id: "innerGroup",
                                nodeType: "Group",
                                fields: { translation: [0, 0] },
                                focusGroup: {
                                    defaultFocusId: "item1"
                                },
                                children: [
                                    {
                                        id: "item1",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [0, 0] },
                                        focus: {}
                                    },
                                    {
                                        id: "item2",
                                        nodeType: "Rectangle",
                                        fields: { width: 100, height: 50, translation: [150, 0] },
                                        focus: {}
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: "outsideItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 200] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' Step 1: Focus item2 (nested inside innerGroup)
            item2 = m.fwInstance.getWidget("item2")
            item2.setFocus()

            ' Step 2: Move focus away to trigger blur (lastFocusedHID is set on blur)
            outsideItem = m.fwInstance.getWidget("outsideItem")
            outsideItem.setFocus()

            ' Then: outerGroup should NOT remember item2 (no enableDeepLastFocusId)
            outerGroupWidget = m.fwInstance.getWidget("outerGroup")
            outerGroup = focusPlugin.groupStack.get(outerGroupWidget.HID)
            m.assertEqual(outerGroup.lastFocusedHID, "")

            ' But innerGroup (immediate parent) SHOULD remember
            innerGroupWidget = m.fwInstance.getWidget("innerGroup")
            innerGroup = focusPlugin.groupStack.get(innerGroupWidget.HID)
            m.assertEqual(innerGroup.lastFocusedHID, item2.HID)
        end function

        @it("enableDeepLastFocusId defaults to false")
        function _()
            ' Given: A group without explicit enableDeepLastFocusId setting
            template = {
                id: "defaultTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "testItem"
                },
                children: [
                    {
                        id: "testItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' When: Get the group from stack
            rootWidget = m.fwInstance.getWidget("defaultTestRoot")
            group = focusPlugin.groupStack.get(rootWidget.HID)

            ' Then: enableDeepLastFocusId should default to false
            m.assertFalse(group.enableDeepLastFocusId)
        end function

        @it("enableLastFocusId defaults to true")
        function _()
            ' Given: A group without explicit enableLastFocusId setting
            template = {
                id: "defaultLastFocusTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "testItem"
                },
                children: [
                    {
                        id: "testItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' When: Get the group from stack
            rootWidget = m.fwInstance.getWidget("defaultLastFocusTestRoot")
            group = focusPlugin.groupStack.get(rootWidget.HID)

            ' Then: enableLastFocusId should default to true
            m.assertTrue(group.enableLastFocusId)
        end function

        @it("immediate parent does NOT store lastFocusedHID when enableLastFocusId is false")
        function _()
            ' Given: A group with enableLastFocusId: false
            template = {
                id: "noLastFocusTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "parentGroup"
                },
                children: [
                    {
                        id: "parentGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "childItem1",
                            enableLastFocusId: false
                        },
                        children: [
                            {
                                id: "childItem1",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "childItem2",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [150, 0] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "outsideItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 200] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' Step 1: Focus childItem2
            childItem2 = m.fwInstance.getWidget("childItem2")
            childItem2.setFocus()

            ' Step 2: Move focus away to trigger blur
            outsideItem = m.fwInstance.getWidget("outsideItem")
            outsideItem.setFocus()

            ' Then: Parent group should NOT store lastFocusedHID (enableLastFocusId: false)
            parentGroupWidget = m.fwInstance.getWidget("parentGroup")
            parentGroup = focusPlugin.groupStack.get(parentGroupWidget.HID)
            m.assertEqual(parentGroup.lastFocusedHID, "")
        end function

        @it("immediate parent stores lastFocusedHID when enableLastFocusId is true (explicit)")
        function _()
            ' Given: A group with enableLastFocusId: true (explicit)
            template = {
                id: "explicitLastFocusTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "parentGroup"
                },
                children: [
                    {
                        id: "parentGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "childItem1",
                            enableLastFocusId: true
                        },
                        children: [
                            {
                                id: "childItem1",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "childItem2",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 50, translation: [150, 0] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "outsideItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 200] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus

            ' Step 1: Focus childItem2
            childItem2 = m.fwInstance.getWidget("childItem2")
            childItem2.setFocus()

            ' Step 2: Move focus away to trigger blur
            outsideItem = m.fwInstance.getWidget("outsideItem")
            outsideItem.setFocus()

            ' Then: Parent group SHOULD store lastFocusedHID (enableLastFocusId: true)
            parentGroupWidget = m.fwInstance.getWidget("parentGroup")
            parentGroup = focusPlugin.groupStack.get(parentGroupWidget.HID)
            m.assertEqual(parentGroup.lastFocusedHID, childItem2.HID)
        end function

        ' ======================================================================
        ' TEST SUITE 14: enableSpatialEnter
        ' ======================================================================

        @describe("enableSpatialEnter - spatial group entry")

        @it("enters group at geometrically closest item instead of defaultFocusId")
        function _()
            ' Given: Two groups side by side
            '   sourceGroup on the left with sourceTop (y=0) and sourceBottom (y=200)
            '   targetGroup on the right with enableSpatialEnter: true,
            '     defaultFocusId: "targetTop", targetTop (y=0), targetBottom (y=200)
            '
            ' When focus is on sourceBottom and we navigate right,
            ' enableSpatialEnter should pick targetBottom (closest) instead of targetTop (default)
            template = {
                id: "spatialEnterRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "sourceGroup"
                },
                children: [
                    {
                        id: "sourceGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "sourceTop",
                            right: "targetGroup"
                        },
                        children: [
                            {
                                id: "sourceTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "sourceBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "targetTop",
                            enableSpatialEnter: true,
                            left: "sourceGroup"
                        },
                        children: [
                            {
                                id: "targetTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Focus sourceBottom
            sourceBottom = m.fwInstance.getWidget("sourceBottom")
            sourceBottom.setFocus()

            ' When: Press right to enter targetGroup
            sourceBottom.triggerKeyPress("right")

            ' Then: Focus should be on targetBottom (spatially closest), not targetTop (default)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetBottom")
        end function

        @it("enters group at default item when focus is closest to it")
        function _()
            ' Given: Same layout, but focus is on sourceTop (y=0)
            ' targetTop is at y=0, targetBottom at y=200
            ' So targetTop (the default) is also the closest
            template = {
                id: "spatialEnterDefaultRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "sourceGroup"
                },
                children: [
                    {
                        id: "sourceGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "sourceTop",
                            right: "targetGroup"
                        },
                        children: [
                            {
                                id: "sourceTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "sourceBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "targetTop",
                            enableSpatialEnter: true,
                            left: "sourceGroup"
                        },
                        children: [
                            {
                                id: "targetTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Focus sourceTop
            sourceTop = m.fwInstance.getWidget("sourceTop")
            sourceTop.setFocus()

            ' When: Press right to enter targetGroup
            sourceTop.triggerKeyPress("right")

            ' Then: Focus should be on targetTop (both default and spatially closest)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetTop")
        end function

        @it("without enableSpatialEnter uses defaultFocusId regardless of position")
        function _()
            ' Given: targetGroup does NOT have enableSpatialEnter
            ' Focus is on sourceBottom (y=200), targetTop is defaultFocusId at y=0
            template = {
                id: "noSpatialEnterRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "sourceGroup"
                },
                children: [
                    {
                        id: "sourceGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "sourceTop",
                            right: "targetGroup"
                        },
                        children: [
                            {
                                id: "sourceTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "sourceBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "targetTop",
                            left: "sourceGroup"
                        },
                        children: [
                            {
                                id: "targetTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Focus sourceBottom
            sourceBottom = m.fwInstance.getWidget("sourceBottom")
            sourceBottom.setFocus()

            ' When: Press right to enter targetGroup
            sourceBottom.triggerKeyPress("right")

            ' Then: Focus should be on targetTop (defaultFocusId), NOT spatially closest
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetTop")
        end function

        @it("works even when source focusItem has enableSpatialNavigation=false")
        function _()
            ' Given: Source items have enableSpatialNavigation: false
            ' enableSpatialEnter uses its own distance calculation (not spatialNavigation())
            ' so it should still pick the closest item in the target group
            template = {
                id: "spatialEnterNoSpatialNavRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "sourceGroup"
                },
                children: [
                    {
                        id: "sourceGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "sourceTop",
                            right: "targetGroup"
                        },
                        children: [
                            {
                                id: "sourceTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {
                                    enableSpatialNavigation: false
                                }
                            },
                            {
                                id: "sourceBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {
                                    enableSpatialNavigation: false
                                }
                            }
                        ]
                    },
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "targetTop",
                            enableSpatialEnter: true,
                            left: "sourceGroup"
                        },
                        children: [
                            {
                                id: "targetTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Focus sourceBottom (which has enableSpatialNavigation: false)
            sourceBottom = m.fwInstance.getWidget("sourceBottom")
            sourceBottom.setFocus()

            ' When: Press right to enter targetGroup
            sourceBottom.triggerKeyPress("right")

            ' Then: enableSpatialEnter should still work - targetBottom is closest
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetBottom")
        end function

        @it("falls back to defaultFocusId when no global focus is set")
        function _()
            ' Given: enableSpatialEnter group but no previous focus (edge case)
            template = {
                id: "spatialEnterFallbackRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "targetGroup"
                },
                children: [
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "targetItem1",
                            enableSpatialEnter: true
                        },
                        children: [
                            {
                                id: "targetItem1",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetItem2",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' When: Set focus on group (no prior focus exists)
            targetGroup = m.fwInstance.getWidget("targetGroup")
            targetGroup.setFocus()

            ' Then: Should fall back to defaultFocusId since no previous focus for spatial calc
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetItem1")
        end function

        @it("enableSpatialEnter skips lastFocusedHID and uses spatial calculation")
        function _()
            ' Given: enableSpatialEnter group where lastFocusedHID was set to targetTop
            ' but current focus position is closer to targetBottom
            template = {
                id: "spatialEnterSkipLastRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "sourceGroup"
                },
                children: [
                    {
                        id: "sourceGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "sourceTop",
                            right: "targetGroup"
                        },
                        children: [
                            {
                                id: "sourceTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "sourceBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "targetGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "targetTop",
                            enableSpatialEnter: true,
                            left: "sourceGroup"
                        },
                        children: [
                            {
                                id: "targetTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "targetBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Step 1: Enter targetGroup from top (sets lastFocusedHID to targetTop)
            sourceTop = m.fwInstance.getWidget("sourceTop")
            sourceTop.setFocus()
            sourceTop.triggerKeyPress("right")

            ' Verify we're on targetTop
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "targetTop")

            ' Step 2: Navigate back to source
            targetTop = m.fwInstance.getWidget("targetTop")
            targetTop.triggerKeyPress("left")

            ' Step 3: Move to sourceBottom
            sourceBottom = m.fwInstance.getWidget("sourceBottom")
            sourceBottom.setFocus()

            ' Step 4: Re-enter targetGroup from bottom position
            sourceBottom.triggerKeyPress("right")

            ' Then: enableSpatialEnter should ignore lastFocusedHID (targetTop)
            '       and pick targetBottom (spatially closest)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "targetBottom")
        end function

        @it("enableSpatialEnter defaults to false on groups")
        function _()
            ' Given: A group without enableSpatialEnter configured
            focusPlugin = m.fwInstance.plugins.focus
            groupL2Widget = m.fwInstance.getWidget("GroupL2")
            group = focusPlugin.groupStack.get(groupL2Widget.HID)

            ' Then: enableSpatialEnter should default to false
            m.assertFalse(group.enableSpatialEnter)
        end function

        ' ======================================================================
        ' TEST SUITE 15: beforeUpdate hook - widget focus config update
        ' ======================================================================

        @describe("beforeUpdate hook - focus config update")

        @it("beforeUpdate removes old focus config and applies new config")
        function _()
            ' Given: A template with a focus item that has onSelect callback
            template = {
                id: "updateTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "updateItem"
                },
                children: [
                    {
                        id: "updateItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {
                            onSelect: sub()
                                m.testMarker = "original_select"
                            end sub
                        }
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Verify initial setup
            widget = m.fwInstance.getWidget("updateItem")
            m.assertNotInvalid(widget)
            widget.setFocus()

            focusPlugin = m.fwInstance.plugins.focus
            focusItem = focusPlugin.focusItemStack.get(widget.HID)
            m.assertNotInvalid(focusItem)

            ' When: Re-render with updated focus config (onFocus instead of onSelect)
            updatedTemplate = {
                id: "updateTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "updateItem"
                },
                children: [
                    {
                        id: "updateItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {
                            onFocus: sub()
                                m.testMarker = "updated_focus"
                            end sub
                        }
                    }
                ]
            }

            m.fwInstance.render(updatedTemplate)

            ' Then: Widget should still be in focus stack with updated config
            updatedWidget = m.fwInstance.getWidget("updateItem")
            m.assertNotInvalid(updatedWidget)

            updatedFocusItem = focusPlugin.focusItemStack.get(updatedWidget.HID)
            m.assertNotInvalid(updatedFocusItem)
        end function

        ' ======================================================================
        ' TEST SUITE 16: beforeDestroy clears global focus
        ' ======================================================================

        @describe("beforeDestroy clears global focus")

        @it("erasing a focused widget clears globalFocusHID and globalFocusId")
        function _()
            ' Given: A template with a focusable widget
            template = {
                id: "destroyFocusTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "erasableItem"
                },
                children: [
                    {
                        id: "erasableItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Set focus on the item
            widget = m.fwInstance.getWidget("erasableItem")
            widget.setFocus()

            ' Verify focus is set
            focusPlugin = m.fwInstance.plugins.focus
            m.assertEqual(focusPlugin.globalFocusId, "erasableItem")
            m.assertTrue(focusPlugin.globalFocusHID <> "")

            ' When: Erase the focused widget
            m.fwInstance.erase("erasableItem")

            ' Then: Global focus should be cleared
            m.assertEqual(focusPlugin.globalFocusHID, "")
            m.assertEqual(focusPlugin.globalFocusId, "")
        end function

        ' ======================================================================
        ' TEST SUITE 17: Both focus + focusGroup validation error
        ' ======================================================================

        @describe("focus + focusGroup validation")

        @it("widget with both focus and focusGroup is skipped")
        function _()
            ' Given: A template with a widget that has BOTH focus and focusGroup
            template = {
                id: "dualConfigTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "dualConfigItem"
                },
                children: [
                    {
                        id: "dualConfigItem",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {
                            onSelect: sub()
                            end sub
                        },
                        focusGroup: {
                            defaultFocusId: "someChild"
                        }
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Then: Widget should NOT be in either stack (validation error skips setup)
            focusPlugin = m.fwInstance.plugins.focus
            dualWidget = m.fwInstance.getWidget("dualConfigItem")
            m.assertNotInvalid(dualWidget)

            focusItem = focusPlugin.focusItemStack.get(dualWidget.HID)
            m.assertInvalid(focusItem)

            group = focusPlugin.groupStack.get(dualWidget.HID)
            m.assertInvalid(group)
        end function

        ' ======================================================================
        ' TEST SUITE 18: Focus restoration on re-creation
        ' ======================================================================

        @describe("focus restoration on widget re-creation")

        @it("restores focus state when a previously focused widget is re-created")
        function _()
            ' Given: A template with two focusable items
            template = {
                id: "restoreTestRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "restoreItem1"
                },
                children: [
                    {
                        id: "restoreItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {}
                    },
                    {
                        id: "restoreItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            ' Focus restoreItem1
            item1 = m.fwInstance.getWidget("restoreItem1")
            item1.setFocus()

            ' Verify focus is on restoreItem1
            focusPlugin = m.fwInstance.plugins.focus
            m.assertEqual(focusPlugin.globalFocusId, "restoreItem1")
            item1HID = item1.HID

            ' When: Re-render (which triggers update/re-creation)
            m.fwInstance.render(template)

            ' Then: The focus item should have isFocused restored
            reCreatedItem = focusPlugin.focusItemStack.get(item1HID)
            m.assertNotInvalid(reCreatedItem)
            m.assertTrue(reCreatedItem.isFocused)
        end function

        ' ======================================================================
        ' TEST SUITE 19: No ancestor group navigation
        ' ======================================================================

        @describe("no ancestor group - all items as candidates")

        @it("focus item with no ancestor group uses all focus items as candidates")
        function _()
            ' Given: A template with focus items directly under root (no focusGroup wrapper)
            template = {
                id: "noGroupTestRoot",
                nodeType: "Group",
                children: [
                    {
                        id: "orphanItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {}
                    },
                    {
                        id: "orphanItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {
                            enableSpatialNavigation: true
                        }
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            focusPlugin = m.fwInstance.plugins.focus
            ' Disable long press to prevent async timer callback issues
            focusPlugin.enableLongPressFeature = false

            ' Set focus on orphanItem1
            item1 = m.fwInstance.getWidget("orphanItem1")
            item1.setFocus()

            ' Verify focus is on orphanItem1
            focusedWidget = focusPlugin.getFocusedWidget()
            m.assertEqual(focusedWidget.id, "orphanItem1")

            ' Verify the item has no ancestor groups
            ancestorGroups = focusPlugin.findAncestorGroups(item1.HID)
            m.assertEqual(ancestorGroups.Count(), 0)

            ' When: Try to navigate (triggers executeNavigationAction with ancestorGroupsCount=0)
            item1.triggerKeyPress("right")

            ' Then: Should not crash (path where all focus items are candidates was exercised)
            m.assertTrue(true)
        end function

        ' ======================================================================
        ' TEST SUITE 20: enableSpatialEnter as AA (per-direction)
        ' ======================================================================

        @describe("enableSpatialEnter with per-direction AA config")

        @it("AA enableSpatialEnter picks closest item for enabled direction")
        function _()
            ' Given: targetGroup has enableSpatialEnter: { right: true }
            ' This covers isSpatialEnterEnabledForDirection lines 1419-1420
            template = {
                id: "aaSpatialEnterRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "aaSrcGroup"
                },
                children: [
                    {
                        id: "aaSrcGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "aaSrcTop",
                            right: "aaTgtGroup"
                        },
                        children: [
                            {
                                id: "aaSrcTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "aaSrcBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "aaTgtGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "aaTgtTop",
                            enableSpatialEnter: { right: true },
                            left: "aaSrcGroup"
                        },
                        children: [
                            {
                                id: "aaTgtTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "aaTgtBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)
            m.fwInstance.plugins.focus.enableLongPressFeature = false

            ' Focus srcBottom (y=200)
            srcBottom = m.fwInstance.getWidget("aaSrcBottom")
            srcBottom.setFocus()

            ' When: Press right to enter targetGroup
            srcBottom.triggerKeyPress("right")

            ' Then: Spatial enter enabled for right  picks aaTgtBottom (closest to srcBottom)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "aaTgtBottom")
        end function

        @it("AA enableSpatialEnter falls back to default for disabled direction")
        function _()
            ' Given: targetGroup has enableSpatialEnter: { left: true } (only left enabled)
            ' Entering from right press  direction "right" not in AA  returns false (line 1422)
            template = {
                id: "aaFallbackRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: "fbSrcGroup"
                },
                children: [
                    {
                        id: "fbSrcGroup",
                        nodeType: "Group",
                        fields: { translation: [0, 0] },
                        focusGroup: {
                            defaultFocusId: "fbSrcTop",
                            right: "fbTgtGroup"
                        },
                        children: [
                            {
                                id: "fbSrcTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "fbSrcBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    },
                    {
                        id: "fbTgtGroup",
                        nodeType: "Group",
                        fields: { translation: [300, 0] },
                        focusGroup: {
                            defaultFocusId: "fbTgtTop",
                            enableSpatialEnter: { left: true },
                            left: "fbSrcGroup"
                        },
                        children: [
                            {
                                id: "fbTgtTop",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 0] },
                                focus: {}
                            },
                            {
                                id: "fbTgtBottom",
                                nodeType: "Rectangle",
                                fields: { width: 100, height: 80, translation: [0, 200] },
                                focus: {}
                            }
                        ]
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)
            m.fwInstance.plugins.focus.enableLongPressFeature = false

            ' Focus fbSrcBottom (y=200)
            srcBottom = m.fwInstance.getWidget("fbSrcBottom")
            srcBottom.setFocus()

            ' When: Press right to enter targetGroup
            ' Direction "right" is NOT in enableSpatialEnter AA  falls back to defaultFocusId
            srcBottom.triggerKeyPress("right")

            ' Then: Should use defaultFocusId (fbTgtTop) NOT spatial closest
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "fbTgtTop")
        end function

        ' ======================================================================
        ' TEST SUITE 21: Function-based defaultFocusId
        ' ======================================================================

        @describe("function-based defaultFocusId")

        @it("defaultFocusId as function resolves dynamically")
        function _()
            ' Given: A group with function-based defaultFocusId
            ' Covers getFallbackNodeId line 1511-1512 and getFallbackIdentifier line 1531-1532
            template = {
                id: "fnDefaultRoot",
                nodeType: "Group",
                focusGroup: {
                    defaultFocusId: function()
                        return "fnItem2"
                    end function
                },
                children: [
                    {
                        id: "fnItem1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [0, 0] },
                        focus: {}
                    },
                    {
                        id: "fnItem2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)
            m.fwInstance.plugins.focus.enableLongPressFeature = false

            ' When: Set focus on the root group (triggers capturing with function defaultFocusId)
            rootWidget = m.fwInstance.getWidget("fnDefaultRoot")
            rootWidget.setFocus()

            ' Then: Focus should be on fnItem2 (resolved by function)
            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertEqual(focusedWidget.id, "fnItem2")
        end function

        ' ======================================================================
        ' TEST SUITE 22: focusItemStack.hasEnabled edge case
        ' ======================================================================

        @describe("focusItemStack utility methods")

        @it("hasEnabled returns false for non-existent HID")
        function _()
            ' Given: Focus plugin with populated focusItemStack
            focusPlugin = m.fwInstance.plugins.focus

            ' When: Check hasEnabled for a HID that doesn't exist
            result = focusPlugin.focusItemStack.hasEnabled("nonExistent.123.456")

            ' Then: Should return false (covers line 1250-1251)
            m.assertFalse(result)
        end function

        @it("hasEnabled returns true for existing enabled focus item")
        function _()
            ' Given: L1 is a focus item in the stack
            focusPlugin = m.fwInstance.plugins.focus
            l1Widget = m.fwInstance.getWidget("L1")

            ' When: Check hasEnabled for L1's HID
            result = focusPlugin.focusItemStack.hasEnabled(l1Widget.HID)

            ' Then: Should return true (item exists and is enabled)
            m.assertTrue(result)
        end function

        ' ======================================================================
        ' TEST SUITE 23: deepSearchFocusItemByNodeId fallback paths
        ' ======================================================================

        @describe("deepSearchFocusItemByNodeId fallback")

        @it("deep search returns empty for non-existent nodeId")
        function _()
            ' Given: Focus plugin
            focusPlugin = m.fwInstance.plugins.focus
            topWidget = m.fwInstance.getWidget("topWidget")

            ' When: Search for a nodeId that doesn't exist
            result = focusPlugin.deepSearchFocusItemByNodeId(topWidget.HID, "completelyNonExistentId")

            ' Then: Should return empty string
            m.assertEqual(result, "")
        end function

        @it("deep search returns empty for empty nodeId")
        function _()
            ' Given: Focus plugin
            focusPlugin = m.fwInstance.plugins.focus
            topWidget = m.fwInstance.getWidget("topWidget")

            ' When: Search with empty nodeId
            result = focusPlugin.deepSearchFocusItemByNodeId(topWidget.HID, "")

            ' Then: Should return empty string (early return line 880)
            m.assertEqual(result, "")
        end function

        @describe("focus plugin cleanup")

        @it("removeFocusConfig removes focus item from stack")
        function _()
            ' Given: L1 widget with focus config
            l1Widget = m.fwInstance.getWidget("L1")
            focusPlugin = m.fwInstance.plugins.focus

            ' Verify L1 is in focus stack
            focusItem = focusPlugin.focusItemStack.get(l1Widget.HID)
            m.assertNotInvalid(focusItem)

            ' When: Remove focus config
            focusPlugin.removeFocusConfig(l1Widget.HID)

            ' Then: L1 should be removed from stack
            focusItem = focusPlugin.focusItemStack.get(l1Widget.HID)
            m.assertInvalid(focusItem)
        end function

        @it("destroy cleans up focus plugin resources")
        function _()
            ' Given: Focus plugin with active focus
            focusPlugin = m.fwInstance.plugins.focus
            l1Widget = m.fwInstance.getWidget("L1")
            m.assertNotInvalid(l1Widget)

            ' Verify L1 is in focus stacks before destroy
            focusItem = focusPlugin.focusItemStack.get(l1Widget.HID)
            m.assertNotInvalid(focusItem)

            ' When: Destroy plugin
            focusPlugin.destroy()

            ' Then: Focus stacks should be empty
            m.assertEqual(focusPlugin.focusItemStack.getAll().Count(), 0)
            m.assertEqual(focusPlugin.groupStack.getAll().Count(), 0)

            ' Timer should be invalid
            m.assertInvalid(focusPlugin.longPressTimer)
            m.assertInvalid(focusPlugin.widgetTree)
        end function

        ' ======================================================================
        ' TEST SUITE: isFocused() widget method
        ' ======================================================================

        @describe("isFocused widget method")

        @it("returns true for focused FocusItem")
        function _()
            ' Given: L1 has focus (set in beforeEach)
            l1Widget = m.fwInstance.getWidget("L1")

            ' Then: isFocused should return true
            m.assertTrue(l1Widget.isFocused())
        end function

        @it("returns false for unfocused FocusItem")
        function _()
            ' Given: L1 has focus, L2 does not
            l2Widget = m.fwInstance.getWidget("L2")

            ' Then: isFocused should return false for L2
            m.assertFalse(l2Widget.isFocused())
        end function

        @it("returns true for group in focus chain")
        function _()
            ' Given: L1 has focus, GroupL2 is its ancestor group
            groupL2Widget = m.fwInstance.getWidget("GroupL2")

            ' Then: isFocused should return true (group is in focus chain)
            m.assertTrue(groupL2Widget.isFocused())
        end function

        @it("returns false for group not in focus chain")
        function _()
            ' Given: L1 has focus, GroupR2 is not in focus chain
            groupR2Widget = m.fwInstance.getWidget("GroupR2")

            ' Then: isFocused should return false
            m.assertFalse(groupR2Widget.isFocused())
        end function

        @it("updates correctly after focus change")
        function _()
            ' Given: L1 has focus
            l1Widget = m.fwInstance.getWidget("L1")
            r1Widget = m.fwInstance.getWidget("R1")
            m.assertTrue(l1Widget.isFocused())
            m.assertFalse(r1Widget.isFocused())

            ' When: Move focus to R1
            r1Widget.setFocus()

            ' Then: L1 should no longer be focused, R1 should be
            m.assertFalse(l1Widget.isFocused())
            m.assertTrue(r1Widget.isFocused())
        end function

        @it("viewModelState.isFocused is not set on non-ViewModel widgets")
        function _()
            ' Note: widgets in this template are NOT ViewModels
            ' viewModelState.isFocused should NOT be initialized for them
            l1Widget = m.fwInstance.getWidget("L1")

            ' Then: viewModelState.isFocused should NOT exist (L1 is not a ViewModel)
            m.assertFalse(l1Widget.viewModelState.DoesExist("isFocused"))
        end function

        ' ======================================================================
        ' TEST SUITE: Long press widget methods
        ' ======================================================================

        @describe("long press widget methods")

        @it("isLongPressActive returns false by default")
        function _()
            l1Widget = m.fwInstance.getWidget("L1")
            m.assertFalse(l1Widget.isLongPressActive())
        end function

        @it("proceedLongPress returns result object")
        function _()
            l1Widget = m.fwInstance.getWidget("L1")
            result = l1Widget.proceedLongPress()
            m.assertNotInvalid(result)
            m.assertFalse(result.handled)
        end function

        ' ======================================================================
        ' TEST SUITE: checkLongPressState key release
        ' ======================================================================

        @describe("long press state management")

        @it("key release resets long press state")
        function _()
            focusPlugin = m.fwInstance.plugins.focus
            ' Enable long press feature for this test
            focusPlugin.enableLongPressFeature = true

            ' When: Simulate key release (press = false)
            focusPlugin.checkLongPressState("right", false)

            ' Then: Long press state should be reset
            m.assertFalse(focusPlugin.isLongPress)
            m.assertEqual(focusPlugin.longPressKey, "")
        end function

        @it("proceedLongPress returns handled=false when navigation disabled")
        function _()
            focusPlugin = m.fwInstance.plugins.focus
            focusPlugin.enableFocusNavigation = false

            result = focusPlugin.proceedLongPress()
            m.assertFalse(result.handled)

            ' Restore
            focusPlugin.enableFocusNavigation = true
        end function

        ' ======================================================================
        ' TEST SUITE: setFocus on invisible widget
        ' ======================================================================

        @describe("setFocus edge cases - visibility and native focus")

        @it("setFocus returns false for invisible widget")
        function _()
            ' Given: Make R1 invisible
            r1Widget = m.fwInstance.getWidget("R1")
            r1Widget.node.visible = false

            ' When: Try to focus R1
            result = r1Widget.setFocus()

            ' Then: Should fail
            m.assertFalse(result)

            ' Cleanup
            r1Widget.node.visible = true
        end function

        @it("setFocus with enableNativeFocus sets native focus on node")
        function _()
            ' Given: R1 with native focus enabled
            r1Widget = m.fwInstance.getWidget("R1")

            ' When: Focus R1 with enableNativeFocus
            result = r1Widget.setFocus(true, true)

            ' Then: Should succeed and node should have native focus
            m.assertTrue(result)
            m.assertTrue(r1Widget.node.hasFocus())
        end function

        @describe("first child fallback")

        @it("focuses first child when group has no defaultFocusId")
        function _()
            template = {
                id: "fallbackRoot",
                nodeType: "Group",
                focusGroup: {},
                children: [
                    {
                        id: "fallbackChild1",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50 },
                        focus: {}
                    },
                    {
                        id: "fallbackChild2",
                        nodeType: "Rectangle",
                        fields: { width: 100, height: 50, translation: [150, 0] },
                        focus: {}
                    }
                ]
            }

            m.fwInstance.destroy()
            m.fwInstance = new Rotor.Framework()
            m.fwInstance.render(template)

            rootWidget = m.fwInstance.getWidget("fallbackRoot")
            rootWidget.setFocus()

            focusedWidget = m.fwInstance.plugins.focus.getFocusedWidget()
            m.assertNotInvalid(focusedWidget)
            m.assertTrue(focusedWidget.id = "fallbackChild1" or focusedWidget.id = "fallbackChild2")
        end function

        end class
end namespace
