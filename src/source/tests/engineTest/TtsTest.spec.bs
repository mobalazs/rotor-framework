import "pkg:/source/engine/services/Tts.bs"
import "pkg:/source/utils/GeneralUtils.bs"

namespace tests

    @suite("TtsService basic functionality")
    class TtsServiceSuite extends rooibos.BaseTestSuite

        ttsService as Rotor.ViewBuilder.TtsService

        protected override function beforeEach()
            ' Create TTS service without calling init()
            ' init() requires SceneGraph objects not available in test environment
            m.ttsService = new Rotor.ViewBuilder.TtsService()

            ' Manually initialize only the parts needed for pure function tests
            m.ttsService.symbolDictionary = {
                "@": "at",
                ".": "dot",
                "-": "dash",
                "_": "underscore",
                "#": "hash",
                "$": "dollar",
                "%": "percent",
                "&": "and",
                "*": "star",
                "+": "plus",
                "=": "equals",
                "/": "slash",
                "\": "backslash",
                "|": "pipe",
                "~": "tilde",
                "^": "caret",
                "<": "less than",
                ">": "greater than",
                "(": "open paren",
                ")": "close paren",
                "[": "open bracket",
                "]": "close bracket",
                "{": "open brace",
                "}": "close brace",
                ",": "comma",
                ":": "colon",
                ";": "semicolon"
            }
            m.ttsService.decimalRegex = /(\d+)\.(\d+)/
            m.ttsService.lastSpeech = ""
            m.ttsService.overrideNextFlushFlag = false
            m.ttsService.isEnabled = false  ' Disabled in test env
            m.ttsService.pendingSpeech = invalid
            m.ttsService.debounceDelay = 200
            m.ttsService.debounceTimer = invalid  ' No roTimespan in test
            m.ttsService.timerNode = invalid
            m.ttsService.audioGuide = invalid
            m.ttsService.deviceInfo = invalid
            m.ttsService.frameworkInstance = invalid
        end function

        @describe("service state management")

        @it("initializes with disabled state in test environment")
        function initDisabled()
            ' Note: In test environment, device AudioGuide is not available
            ' Service should be disabled
            m.assertFalse(m.ttsService.isEnabled)
        end function

        @it("tracks last speech")
        function trackLastSpeech()
            initialLast = m.ttsService.lastSpeech
            m.assertEqual(initialLast, "")
        end function

        @it("has symbol dictionary")
        function hasSymbolDict()
            m.assertNotInvalid(m.ttsService.symbolDictionary)
            m.assertTrue(m.ttsService.symbolDictionary.DoesExist("@"))
            m.assertEqual(m.ttsService.symbolDictionary["@"], "at")
        end function

        @it("updates symbol dictionary")
        function updateDictionary()
            newDict = { "@": "kukac" } ' Hungarian localization
            m.ttsService.setSymbolDictionary(newDict)
            m.assertEqual(m.ttsService.symbolDictionary["@"], "kukac")
        end function

        @it("has overrideNextFlush flag")
        function hasOverrideFlag()
            m.assertFalse(m.ttsService.overrideNextFlushFlag)
        end function

        @describe("processSpellOutMode")

        @it("splits regular text character-by-character")
        function spellOutRegularText()
            result = m.ttsService.processSpellOutMode("ABC")
            m.assertEqual(result, "A B C")
        end function

        @it("handles email addresses")
        function spellOutEmail()
            result = m.ttsService.processSpellOutMode("user@domain.com")
            m.assertEqual(result, "user at domain dot com")
        end function

        @it("handles decimal numbers")
        function spellOutDecimal()
            result = m.ttsService.processSpellOutMode("3.14")
            m.assertEqual(result, "3 point 14")
        end function

        @it("replaces symbols with words")
        function spellOutSymbols()
            result = m.ttsService.processSpellOutMode("@#$")
            m.assertEqual(result, "at hash dollar")
        end function

        @it("handles mixed text with symbols")
        function spellOutMixed()
            result = m.ttsService.processSpellOutMode("A1B2")
            m.assertEqual(result, "A 1 B 2")
        end function

        @it("handles underscore and dash")
        function spellOutSpecialChars()
            result = m.ttsService.processSpellOutMode("test_file-name")
            m.assertEqual(result, "t e s t underscore f i l e dash n a m e")
        end function

        @describe("debounce state")

        @it("initializes with no pending speech")
        function noPendingSpeech()
            m.assertInvalid(m.ttsService.pendingSpeech)
        end function

        @it("has debounce delay configured")
        function hasDebounceDelay()
            m.assertEqual(m.ttsService.debounceDelay, 200)
        end function

        @describe("symbol dictionary customization")

        @it("allows custom symbol dictionary")
        function customSymbolDict()
            customDict = {
                "@": "kukac",
                ".": "pont",
                "-": "kotojel"
            }
            m.ttsService.setSymbolDictionary(customDict)

            result = m.ttsService.processSpellOutMode("@.-")
            m.assertEqual(result, "kukac pont kotojel")
        end function

        @it("handles empty text in spellOut mode")
        function spellOutEmpty()
            result = m.ttsService.processSpellOutMode("")
            m.assertEqual(result, "")
        end function

        @it("handles text with multiple decimals")
        function spellOutMultipleDecimals()
            ' Only first decimal pattern should match
            result = m.ttsService.processSpellOutMode("3.14")
            m.assertEqual(result, "3 point 14")
        end function

        @describe("state flags")

        @it("overrideNextFlush flag starts false")
        function overrideFlagInitial()
            m.assertFalse(m.ttsService.overrideNextFlushFlag)
        end function

        @it("tracks lastSpeech as empty initially")
        function lastSpeechEmpty()
            m.assertEqual(m.ttsService.lastSpeech, "")
        end function

    end class
end namespace
