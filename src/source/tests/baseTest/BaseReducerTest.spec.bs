import "pkg:/source/RotorFramework.bs"
import "pkg:/source/base/BaseReducer.bs"
import "pkg:/source/utils/GeneralUtils.bs"

namespace tests

    @suite("BaseReducerTestSuite")
    class BaseReducerTestSuite extends rooibos.BaseTestSuite

        fwInstance

        protected override function beforeEach()
            m.fwInstance = new Rotor.Framework()
        end function

        protected override function afterEach()
            if m.fwInstance <> invalid
                m.fwInstance.destroy()
                m.fwInstance = invalid
            end if
        end function

        @describe("BaseReducer initialization")

        @it("creates reducer instance")
        function _()
            testReducer = new Rotor.Reducer()

            m.assertNotEqual(testReducer, invalid)
            m.assertTrue(Rotor.Utils.isFunction(testReducer.dispatch))
        end function

        @it("initializes with empty middlewares array")
        function _()
            testReducer = new Rotor.Reducer()

            m.assertNotEqual(testReducer.middlewares, invalid)
            m.assertEqual(testReducer.middlewares.count(), 0)
        end function

        @describe("BaseReducer reducer method")

        @it("returns unchanged state by default")
        function _()
            testReducer = new Rotor.Reducer()
            initialState = { count: 0 }
            intent = { type: "TEST_ACTION", payload: invalid }

            result = testReducer.reducer(initialState, intent)

            m.assertEqual(result.count, 0)
        end function

        @describe("BaseReducer applyMiddlewares method")

        @it("returns empty array by default")
        function _()
            testReducer = new Rotor.Reducer()

            middlewares = testReducer.applyMiddlewares()

            m.assertNotEqual(middlewares, invalid)
            m.assertEqual(middlewares.count(), 0)
        end function

        @describe("BaseReducer getState helper method")

        @it("returns current state from owner dispatcher")
        function _()
            ' Create a simple model and reducer
            model = new Rotor.Model()
            model.state = { count: 42, name: "test" }
            testReducer = new Rotor.Reducer()

            ' Create dispatcher
            dispatcher = Rotor.createDispatcher("testGetState", model, testReducer)

            ' Call getState() from reducer context
            currentState = testReducer.getState()

            m.assertNotEqual(currentState, invalid)
            m.assertEqual(currentState.count, 42)
            m.assertEqual(currentState.name, "test")
        end function

        @describe("BaseReducer registerAsyncTransfer method")

        @it("registers async transfer without crashing")
        function _()
            ' Create model and reducer
            model = new Rotor.Model()
            model.state = { data: invalid }
            testReducer = new Rotor.Reducer()

            ' Create dispatcher
            dispatcher = Rotor.createDispatcher("testAsyncTransfer", model, testReducer)

            ' Create a mock transfer object
            mockTransfer = {
                GetIdentity: function() as object
                    return {
                        ToStr: function() as string
                            return "mock-transfer-123"
                        end function
                    }
                end function
            }

            ' Register async transfer with context
            ' Note: This is a render-thread test, so we can't verify the task-thread
            ' asyncTransferRegistry directly. We just verify the call doesn't crash.
            testReducer.registerAsyncTransfer(mockTransfer, { requestType: "testData" })

            ' Verify the framework instance exists
            frameworkInstance = GetGlobalAA().rotor_framework_helper.frameworkInstance
            m.assertNotEqual(frameworkInstance, invalid)

            ' Success if we got here without crashing
            m.assertTrue(true, "registerAsyncTransfer executed without error")
        end function

        @describe("BaseReducer destroy method")

        @it("cleans up references")
        function _()
            testReducer = new Rotor.Reducer()
            testReducer.ownerDispatcher = { test: "value" }

            testReducer.destroy()

            m.assertEqual(testReducer.ownerDispatcher, invalid)
            m.assertEqual(testReducer.port, invalid)
        end function

    end class
end namespace
